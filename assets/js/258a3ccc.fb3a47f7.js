"use strict";(globalThis.webpackChunkdazzleduck_website=globalThis.webpackChunkdazzleduck_website||[]).push([[2461],{6210:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"dazzleduck-sql-commons/ingestion-utils","title":"Ingestion Utilities","description":"Shared helpers for Arrow-based ingestion, partitioned writes, and Parquet output.","source":"@site/docs/dazzleduck-sql-commons/ingestion-utils.md","sourceDirName":"dazzleduck-sql-commons","slug":"/dazzleduck-sql-commons/ingestion-utils","permalink":"/dazzleduck-website/docs/dazzleduck-sql-commons/ingestion-utils","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_label":"Ingestion","sidebar_position":6},"sidebar":"docSidebar","previous":{"title":"Partition Pruning","permalink":"/dazzleduck-website/docs/dazzleduck-sql-commons/partition-pruning"},"next":{"title":"Overview","permalink":"/dazzleduck-website/docs/dazzleduck-sql-logger/overview"}}');var t=i(4848),r=i(8453);const l={sidebar_label:"Ingestion",sidebar_position:6},o="Ingestion Utilities",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Key Components",id:"key-components",level:2},{value:"ParquetIngestionQueue",id:"parquetingestionqueue",level:2},{value:"Responsibilities",id:"responsibilities",level:3},{value:"SQL Generation",id:"sql-generation",level:2},{value:"Cancellation Support",id:"cancellation-support",level:2},{value:"Production Considerations",id:"production-considerations",level:2}];function a(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"ingestion-utilities",children:"Ingestion Utilities"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Shared helpers for Arrow-based ingestion, partitioned writes, and Parquet output."}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"Ingestion utilities provide reusable components used by:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["HTTP ingestion (",(0,t.jsx)(n.code,{children:"/v1/ingest"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Flight SQL ingestion"}),"\n",(0,t.jsx)(n.li,{children:"Batch pipelines"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"They coordinate Arrow readers, partition logic, transformations, and file output."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"key-components",children:"Key Components"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Component"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ParquetIngestionQueue"})}),(0,t.jsx)(n.td,{children:"Buffered, batched Parquet writes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"BulkIngestQueue"})}),(0,t.jsx)(n.td,{children:"Time / size-based batching"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PostIngestionTask"})}),(0,t.jsx)(n.td,{children:"Metadata and registration hooks"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"MappedReader"})}),(0,t.jsx)(n.td,{children:"Column transformation"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"parquetingestionqueue",children:"ParquetIngestionQueue"}),"\n",(0,t.jsx)(n.h3,{id:"responsibilities",children:"Responsibilities"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Accumulate Arrow batches"}),"\n",(0,t.jsx)(n.li,{children:"Apply transformations"}),"\n",(0,t.jsx)(n.li,{children:"Partition data"}),"\n",(0,t.jsxs)(n.li,{children:["Execute DuckDB ",(0,t.jsx)(n.code,{children:"COPY"})," statements"]}),"\n",(0,t.jsx)(n.li,{children:"Emit ingestion metadata"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Writes occur when:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Bucket size threshold is reached, or"}),"\n",(0,t.jsx)(n.li,{children:"Max delay expires"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"sql-generation",children:"SQL Generation"}),"\n",(0,t.jsx)(n.p,{children:"Ingestion uses DuckDB's native COPY:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"COPY (\n  SELECT *, expr AS col\n  FROM read_arrow([...])\n  ORDER BY col\n)\nTO 'path'\n(FORMAT parquet, PARTITION_BY(col), RETURN_FILES);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"cancellation-support",children:"Cancellation Support"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Each write task registers a cancel hook"}),"\n",(0,t.jsx)(n.li,{children:"Active DuckDB statements are cancelled safely"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"production-considerations",children:"Production Considerations"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Tune batch sizes carefully"}),"\n",(0,t.jsx)(n.li,{children:"Monitor memory usage"}),"\n",(0,t.jsx)(n.li,{children:"Prefer partitioned writes"}),"\n",(0,t.jsx)(n.li,{children:"Handle retries at producer layer"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var s=i(6540);const t={},r=s.createContext(t);function l(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);